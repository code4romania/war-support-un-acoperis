FROM citizennext/webserver:latest

ARG APP_ENV
ARG APP_KEY
ARG APP_URL
ARG APP_DEBUG
ARG DB_HOST
ARG DB_PORT=3306
ARG DB_DATABASE
ARG DB_USERNAME
ARG DB_PASSWORD
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_DEFAULT_REGION
ARG AWS_PUBLIC_BUCKET
ARG AWS_PRIVATE_BUCKET
ARG AWS_CDN_URL
ARG FILESYSTEM_DRIVER
ARG SENTRY_LARAVEL_DSN
ARG MAIL_MAILER
ARG MAIL_MAILER
ARG MAIL_FROM_ADDRESS
ARG MAIL_FROM_NAME
ARG MAIL_HOST
ARG MAIL_PORT
ARG MAIL_USERNAME
ARG MAIL_PASSWORD
ARG MAIL_CONTACT_TO
ARG MAIL_TO_HELP_ADDRESS
ARG CC_MAIL_TO_HELP_ADDRESS
ARG ADMIN_APP_URL
ARG ADMIN_APP_PATH
ARG S3_KEY
ARG S3_SECRET
ARG S3_BUCKET
ARG S3_REGION=eu-central-1
ARG MEDIA_LIBRARY_ACL=public-read
ARG MAILCHIMP_APIKEY
ARG MAILCHIMP_LIST_ID
ARG SESSION_SECURE_COOKIE=true
ARG APP_HOST
ARG SESSION_DRIVER=database
ARG NOCAPTCHA_SECRET
ARG NOCAPTCHA_SITEKEY
ARG GOOGLE_MAPS_API_KEY

ENV APP_ENV ${APP_ENV}
ENV APP_KEY ${APP_KEY}
ENV APP_URL ${APP_URL}
ENV APP_DEBUG ${APP_DEBUG}
ENV DB_HOST ${DB_HOST}
ENV DB_PORT ${DB_PORT}
ENV DB_DATABASE ${DB_DATABASE}
ENV DB_USERNAME ${DB_USERNAME}
ENV DB_PASSWORD ${DB_PASSWORD}
ENV AWS_ACCESS_KEY_ID ${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY ${AWS_SECRET_ACCESS_KEY}
ENV AWS_DEFAULT_REGION ${AWS_DEFAULT_REGION}
ENV AWS_PUBLIC_BUCKET ${AWS_PUBLIC_BUCKET}
ENV AWS_PRIVATE_BUCKET ${AWS_PRIVATE_BUCKET}
ENV AWS_CDN_URL ${AWS_CDN_URL}
ENV FILESYSTEM_DRIVER ${FILESYSTEM_DRIVER}
ENV SENTRY_LARAVEL_DSN ${SENTRY_LARAVEL_DSN}
ENV MAIL_MAILER ${MAIL_MAILER}
ENV MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}
ENV MAIL_FROM_NAME=${MAIL_FROM_NAME}
ENV MAIL_HOST=${MAIL_HOST}
ENV MAIL_PORT=${MAIL_PORT}
ENV MAIL_USERNAME=${MAIL_USERNAME}
ENV MAIL_PASSWORD=${MAIL_PASSWORD}
ENV MAIL_CONTACT_TO=${MAIL_CONTACT_TO}
ENV MAIL_TO_HELP_ADDRESS=${MAIL_TO_HELP_ADDRESS}
ENV ADMIN_APP_URL=null
ENV ADMIN_APP_PATH=${ADMIN_APP_PATH}
ENV S3_KEY=${S3_KEY}
ENV S3_SECRET=${S3_SECRET}
ENV S3_BUCKET=${S3_BUCKET}
ENV S3_REGION=${S3_REGION}
ENV MEDIA_LIBRARY_ACL=${MEDIA_LIBRARY_ACL}
ENV MAILCHIMP_APIKEY=${MAILCHIMP_APIKEY}
ENV MAILCHIMP_LIST_ID=${MAILCHIMP_LIST_ID}
ENV SESSION_SECURE_COOKIE=${SESSION_SECURE_COOKIE}
ENV APP_HOST=${APP_HOST}
ENV SESSION_DRIVER=${SESSION_DRIVER}
ENV NOCAPTCHA_SECRET=${NOCAPTCHA_SECRET}
ENV NOCAPTCHA_SITEKEY=${NOCAPTCHA_SITEKEY}
ENV GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
ENV CC_MAIL_TO_HELP_ADDRESS=${CC_MAIL_TO_HELP_ADDRESS}
# copy application file
COPY . /var/www/html

# create application environment file
RUN cp .env.example .env

# prepare Laravel log
RUN touch /var/www/html/storage/logs/laravel.log
RUN chmod 777 /var/www/html/storage/logs/laravel.log

# fix permissions
RUN chown -R www-data:www-data /var/www/html

# configure Ngnix
COPY .docker/prod/config/nginx/default /etc/nginx/sites-available/default
COPY .docker/prod/config/nginx/nginx.conf /etc/nginx/nginx.conf

# configure php-fpm
COPY .docker/prod/config/php-fpm/www.conf /etc/php/7.4/fpm/pool.d/www.conf

EXPOSE 80

ENTRYPOINT ["/usr/bin/supervisord"]
